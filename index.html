<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🚌 Bus Outing Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="module">
    import React from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

    // ⚠️ แทนที่ด้วย Google Apps Script URL ของคุณ
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJWOsB72_JiiX2flxnxKWcZ5RlYdFHSorvVd7rnqqcfmzLqm9MWTGFkhiPLZYtpDD0/exec';

    // SVG Icons
    const Icons = {
      Users: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('path', { d: 'M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2' }),
        React.createElement('circle', { cx: '9', cy: '7', r: '4' }),
        React.createElement('path', { d: 'M22 21v-2a4 4 0 0 0-3-3.87' }),
        React.createElement('path', { d: 'M16 3.13a4 4 0 0 1 0 7.75' })
      ),
      Clock: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('circle', { cx: '12', cy: '12', r: '10' }),
        React.createElement('polyline', { points: '12 6 12 12 16 14' })
      ),
      RefreshCw: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('polyline', { points: '23 4 23 10 17 10' }),
        React.createElement('polyline', { points: '1 20 1 14 7 14' }),
        React.createElement('path', { d: 'M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15' })
      ),
      CheckCircle: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '14', height: '14', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('path', { d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' }),
        React.createElement('polyline', { points: '22 4 12 14.01 9 11.01' })
      ),
      AlertCircle: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '14', height: '14', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('circle', { cx: '12', cy: '12', r: '10' }),
        React.createElement('line', { x1: '12', y1: '8', x2: '12', y2: '12' }),
        React.createElement('line', { x1: '12', y1: '16', x2: '12.01', y2: '16' })
      ),
      Coffee: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('path', { d: 'M18 8h1a4 4 0 0 1 0 8h-1' }),
        React.createElement('path', { d: 'M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z' }),
        React.createElement('line', { x1: '6', y1: '1', x2: '6', y2: '4' }),
        React.createElement('line', { x1: '10', y1: '1', x2: '10', y2: '4' }),
        React.createElement('line', { x1: '14', y1: '1', x2: '14', y2: '4' })
      ),
      Music: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('path', { d: 'M9 18V5l12-2v13' }),
        React.createElement('circle', { cx: '6', cy: '18', r: '3' }),
        React.createElement('circle', { cx: '18', cy: '16', r: '3' })
      ),
      PartyPopper: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('path', { d: 'M5.8 11.3 2 22l10.7-3.79' }),
        React.createElement('path', { d: 'M4 3h.01' }),
        React.createElement('path', { d: 'M22 8h.01' }),
        React.createElement('path', { d: 'M15 2h.01' }),
        React.createElement('path', { d: 'M22 20h.01' }),
        React.createElement('path', { d: 'm22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12v0c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10' }),
        React.createElement('path', { d: 'm22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11v0c-.11.7-.72 1.22-1.43 1.22H17' }),
        React.createElement('path', { d: 'm11 2 .33.82c.34.86-.2 1.82-1.11 1.98v0C9.52 4.9 9 5.52 9 6.23V7' }),
        React.createElement('path', { d: 'M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z' })
      ),
      Zap: () => React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
        React.createElement('polygon', { points: '13 2 3 14 12 14 11 22 21 10 12 10 13 2' })
      )
    };

    const BusTrackerDashboard = () => {
      const [busData, setBusData] = React.useState({});
      const [waitlist, setWaitlist] = React.useState([]);
      const [totalRegistered, setTotalRegistered] = React.useState(0);
      const [lastUpdate, setLastUpdate] = React.useState(null);
      const [selectedBus, setSelectedBus] = React.useState(null);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);

      const busConfig = {
        '1': { Icon: Icons.Coffee, color: 'bg-green-50 border-green-200', textColor: 'text-green-700' },
        '888': { Icon: Icons.Music, color: 'bg-blue-50 border-blue-200', textColor: 'text-blue-700' },
        '3': { Icon: Icons.PartyPopper, color: 'bg-purple-50 border-purple-200', textColor: 'text-purple-700' },
        '4': { Icon: Icons.Zap, color: 'bg-orange-50 border-orange-200', textColor: 'text-orange-700' },
        '5': { Icon: Icons.Zap, color: 'bg-red-50 border-red-200', textColor: 'text-red-700' }
      };

      const getMockData = () => ({
        buses: {
          '1': {
            passengers: [
              { employeeId: 'EMP001', nickname: 'แจ๊ค', firstChoice: '1', secondChoice: '888', isFirstChoice: true },
              { employeeId: 'EMP015', nickname: 'ปอนด์', firstChoice: '1', secondChoice: '3', isFirstChoice: true },
              { employeeId: 'EMP023', nickname: 'มิ้นต์', firstChoice: '1', secondChoice: '888', isFirstChoice: true },
            ],
            capacity: 45,
            name: 'บัสชิลๆ'
          },
          '888': {
            passengers: [
              { employeeId: 'EMP002', nickname: 'เจน', firstChoice: '888', secondChoice: '3', isFirstChoice: true },
              { employeeId: 'EMP007', nickname: 'ตูน', firstChoice: '888', secondChoice: '4', isFirstChoice: true },
              { employeeId: 'EMP012', nickname: 'ปุ๊ก', firstChoice: '888', secondChoice: '3', isFirstChoice: true },
              { employeeId: 'EMP018', nickname: 'เบลล์', firstChoice: '888', secondChoice: '1', isFirstChoice: true },
              { employeeId: 'EMP025', nickname: 'โอ๊ต', firstChoice: '888', secondChoice: '3', isFirstChoice: true },
            ],
            capacity: 45,
            name: 'บัสอุ่นเครื่อง'
          },
          '3': {
            passengers: [
              { employeeId: 'EMP003', nickname: 'บอล', firstChoice: '3', secondChoice: '4', isFirstChoice: true },
              { employeeId: 'EMP009', nickname: 'ฟิล์ม', firstChoice: '3', secondChoice: '888', isFirstChoice: true },
            ],
            capacity: 45,
            name: 'บัสเปิดปาร์ตี้'
          },
          '4': {
            passengers: [
              { employeeId: 'EMP004', nickname: 'เอิร์ธ', firstChoice: '4', secondChoice: '5', isFirstChoice: true },
              { employeeId: 'EMP011', nickname: 'แบงค์', firstChoice: '4', secondChoice: '3', isFirstChoice: true },
              { employeeId: 'EMP019', nickname: 'กอล์ฟ', firstChoice: '4', secondChoice: '5', isFirstChoice: true },
              { employeeId: 'EMP022', nickname: 'ปาล์ม', firstChoice: '4', secondChoice: '3', isFirstChoice: true },
            ],
            capacity: 45,
            name: 'บัสพลังเต็ม'
          },
          '5': {
            passengers: [
              { employeeId: 'EMP005', nickname: 'ไมค์', firstChoice: '5', secondChoice: '4', isFirstChoice: true },
            ],
            capacity: 45,
            name: 'บัสไม่มีพัก'
          }
        },
        waitlist: [],
        totalRegistered: 15
      });

      const fetchData = async () => {
        try {
          setLoading(true);
          setError(null);
          
          if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
            setTimeout(() => {
              const mockData = getMockData();
              setBusData(mockData.buses);
              setWaitlist(mockData.waitlist);
              setTotalRegistered(mockData.totalRegistered);
              setLastUpdate(new Date());
              setLoading(false);
            }, 500);
            return;
          }

          const response = await fetch(GOOGLE_SCRIPT_URL);
          const data = await response.json();
          
          if (data.error) throw new Error(data.error);
          
          setBusData(data.buses);
          setWaitlist(data.waitlist || []);
          setTotalRegistered(data.totalRegistered);
          setLastUpdate(new Date(data.lastUpdate));
          setLoading(false);
        } catch (err) {
          console.error('Error:', err);
          setError(err.message);
          setLoading(false);
        }
      };

      React.useEffect(() => {
        fetchData();
        const interval = setInterval(fetchData, 30000);
        return () => clearInterval(interval);
      }, []);

      const getAvailableSeats = (bus) => bus.capacity - bus.passengers.length;

      const getStatusBadge = (bus) => {
        const available = getAvailableSeats(bus);
        if (available === 0) {
          return React.createElement('span', { className: 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700' },
            React.createElement(Icons.AlertCircle), 'เต็ม');
        } else if (available <= 5) {
          return React.createElement('span', { className: 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700' },
            React.createElement(Icons.Clock), 'เหลือน้อย');
        }
        return React.createElement('span', { className: 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700' },
          React.createElement(Icons.CheckCircle), 'ว่าง');
      };

      if (loading) {
        return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center' },
          React.createElement('div', { className: 'text-center' },
            React.createElement('div', { className: 'animate-spin text-blue-500 mx-auto mb-4' },
              React.createElement(Icons.RefreshCw)
            ),
            React.createElement('p', { className: 'text-gray-600' }, 'กำลังโหลดข้อมูล...')
          )
        );
      }

      if (error) {
        return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4' },
          React.createElement('div', { className: 'bg-white rounded-2xl shadow-lg p-8 max-w-md text-center' },
            React.createElement('div', { className: 'text-red-500 mx-auto mb-4' }, React.createElement(Icons.AlertCircle)),
            React.createElement('h2', { className: 'text-xl font-bold text-gray-800 mb-2' }, 'เกิดข้อผิดพลาด'),
            React.createElement('p', { className: 'text-gray-600 mb-4' }, error),
            React.createElement('button', {
              onClick: fetchData,
              className: 'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors'
            }, 'ลองอีกครั้ง')
          )
        );
      }

      return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4 md:p-8' },
        React.createElement('div', { className: 'max-w-7xl mx-auto mb-8' },
          React.createElement('div', { className: 'bg-white rounded-2xl shadow-lg p-6 md:p-8' },
            React.createElement('div', { className: 'flex items-start justify-between mb-4' },
              React.createElement('div', null,
                React.createElement('h1', { className: 'text-3xl md:text-4xl font-bold text-gray-800 mb-2' }, '🚌 Company Outing Bus Tracker'),
                React.createElement('p', { className: 'text-gray-600' }, 'ติดตามสถานะการลงทะเบียนรถบัส')
              ),
              React.createElement('button', {
                onClick: fetchData,
                className: 'flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors'
              },
                React.createElement(Icons.RefreshCw),
                React.createElement('span', { className: 'hidden md:inline' }, 'รีเฟรช')
              )
            ),
            React.createElement('div', { className: 'mt-4 flex flex-wrap gap-4 text-sm text-gray-600' },
              React.createElement('div', { className: 'flex items-center gap-2' },
                React.createElement(Icons.Users),
                React.createElement('span', null, 'จำนวนผู้ลงทะเบียน: ', React.createElement('strong', null, totalRegistered), ' คน')
              ),
              lastUpdate && React.createElement('div', { className: 'flex items-center gap-2' },
                React.createElement(Icons.Clock),
                React.createElement('span', null, 'อัพเดทล่าสุด: ', lastUpdate.toLocaleTimeString('th-TH'))
              )
            ),
            waitlist.length > 0 && React.createElement('div', { className: 'mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg' },
              React.createElement('p', { className: 'text-yellow-800 font-medium' }, `⚠️ มี ${waitlist.length} คนที่รถเต็มทั้งสองคัน กำลังรอจัดบัสเพิ่ม`)
            )
          )
        ),
        React.createElement('div', { className: 'max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
          Object.entries(busData).map(([busId, bus]) => {
            const config = busConfig[busId];
            const available = getAvailableSeats(bus);
            const percentage = ((bus.passengers.length / bus.capacity) * 100).toFixed(0);
            const firstChoiceCount = bus.passengers.filter(p => p.isFirstChoice).length;
            const secondChoiceCount = bus.passengers.length - firstChoiceCount;

            return React.createElement('div', {
              key: busId,
              className: `${config.color} border-2 rounded-2xl p-6 transition-all hover:shadow-xl cursor-pointer`,
              onClick: () => setSelectedBus({ id: busId, ...bus, config })
            },
              React.createElement('div', { className: 'flex items-start justify-between mb-4' },
                React.createElement('div', { className: 'flex items-center gap-3' },
                  React.createElement('div', { className: `${config.textColor} bg-white p-3 rounded-xl` },
                    React.createElement(config.Icon)
                  ),
                  React.createElement('div', null,
                    React.createElement('h3', { className: `text-xl font-bold ${config.textColor}` }, `🚌 คันที่ ${busId}`),
                    React.createElement('p', { className: 'text-sm text-gray-600' }, bus.name)
                  )
                ),
                getStatusBadge(bus)
              ),
              React.createElement('div', { className: 'mb-4' },
                React.createElement('div', { className: 'flex justify-between text-sm mb-2' },
                  React.createElement('span', { className: 'text-gray-600' }, 'จำนวนผู้โดยสาร'),
                  React.createElement('span', { className: `font-bold ${config.textColor}` }, `${bus.passengers.length}/${bus.capacity}`)
                ),
                React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-3 overflow-hidden' },
                  React.createElement('div', {
                    className: `h-full ${config.textColor.replace('text-', 'bg-')} transition-all duration-500`,
                    style: { width: `${percentage}%` }
                  })
                )
              ),
              React.createElement('div', { className: 'grid grid-cols-2 gap-3 mb-4 text-sm' },
                React.createElement('div', { className: 'bg-white p-2 rounded-lg' },
                  React.createElement('p', { className: 'text-gray-600 text-xs' }, 'เลือกอันดับ 1'),
                  React.createElement('p', { className: `font-bold ${config.textColor}` }, `${firstChoiceCount} คน`)
                ),
                React.createElement('div', { className: 'bg-white p-2 rounded-lg' },
                  React.createElement('p', { className: 'text-gray-600 text-xs' }, 'ได้รถสำรอง'),
                  React.createElement('p', { className: `font-bold ${config.textColor}` }, `${secondChoiceCount} คน`)
                )
              ),
              React.createElement('div', { className: 'flex items-center justify-between pt-4 border-t border-gray-200' },
                React.createElement('span', { className: 'text-gray-600 text-sm' }, 'ที่นั่งว่าง'),
                React.createElement('span', { className: `text-2xl font-bold ${config.textColor}` }, available)
              ),
              React.createElement('button', {
                className: `mt-4 w-full py-2 px-4 rounded-lg ${config.textColor.replace('text-', 'bg-').replace('700', '100')} ${config.textColor} font-medium hover:opacity-80 transition-opacity`,
                onClick: (e) => { e.stopPropagation(); setSelectedBus({ id: busId, ...bus, config }); }
              }, 'ดูรายชื่อผู้โดยสาร')
            );
          })
        ),
        selectedBus && React.createElement('div', {
          className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50',
          onClick: () => setSelectedBus(null)
        },
          React.createElement('div', {
            className: 'bg-white rounded-2xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl',
            onClick: (e) => e.stopPropagation()
          },
            React.createElement('div', { className: `${selectedBus.config.color} border-b-2 ${selectedBus.config.color.split(' ')[1]} p-6` },
              React.createElement('div', { className: 'flex items-center justify-between' },
                React.createElement('div', null,
                  React.createElement('h2', { className: `text-2xl font-bold ${selectedBus.config.textColor} mb-1` }, `🚌 คันที่ ${selectedBus.id} - ${selectedBus.name}`),
                  React.createElement('p', { className: 'text-gray-600' }, `${selectedBus.passengers.length}/${selectedBus.capacity} ที่นั่ง`)
                ),
                React.createElement('button', {
                  onClick: () => setSelectedBus(null),
                  className: 'text-gray-500 hover:text-gray-700 text-3xl leading-none'
                }, '×')
              )
            ),
            React.createElement('div', { className: 'p-6 overflow-y-auto max-h-[calc(80vh-150px)]' },
              selectedBus.passengers.length > 0 ? React.createElement('div', { className: 'space-y-3' },
                selectedBus.passengers.map((passenger, index) =>
                  React.createElement('div', {
                    key: index,
                    className: 'flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors'
                  },
                    React.createElement('div', {
                      className: `${selectedBus.config.textColor} bg-white w-10 h-10 rounded-full flex items-center justify-center font-bold flex-shrink-0`
                    }, index + 1),
                    React.createElement('div', { className: 'flex-1 min-w-0' },
                      React.createElement('div', { className: 'flex items-center gap-2 mb-1' },
                        React.createElement('p', { className: 'font-semibold text-gray-800' }, passenger.nickname),
                        !passenger.isFirstChoice && React.createElement('span', {
                          className: 'text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded'
                        }, 'รถสำรอง')
                      ),
                      React.createElement('p', { className: 'text-sm text-gray-600' }, `รหัส: ${passenger.employeeId}`)
                    ),
                    React.createElement('div', { className: 'text-xs text-gray-500 hidden md:block flex-shrink-0' },
                      React.createElement('p', null, `อันดับ 1: คันที่ ${passenger.firstChoice}`),
                      React.createElement('p', null, `อันดับ 2: คันที่ ${passenger.secondChoice}`)
                    )
                  )
                )
              ) : React.createElement('div', { className: 'text-center py-12 text-gray-500' },
                React.createElement(Icons.Users),
                React.createElement('p', null, 'ยังไม่มีผู้ลงทะเบียนในรถคันนี้')
              )
            )
          )
        )
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(BusTrackerDashboard));
  </script>
</body>
</html>
